import hashlib
import random
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.asymmetric import padding, rsa
from cryptography.hazmat.backends import default_backend

# --- НАСТРОЙКИ (ПОДТВЕРЖДЕННЫЕ) ---
TARGET_USER = "admin"
MESSAGE = "1234"
ENDIAN = 'big'

# --- 1. ГЕНЕРАЦИЯ КЛЮЧЕЙ ДЛЯ ADMIN ---
seed_str = f"{TARGET_USER}_lovenote_2026_valentine"
seed_bytes = seed_str.encode()

def is_prime(n, k=40):
    if n <= 1: return False
    if n <= 3: return True
    if n % 2 == 0: return False
    r, d = 0, n - 1
    while d % 2 == 0: r += 1; d //= 2
    for _ in range(k):
        a = random.randint(2, n - 2)
        x = pow(a, d, n)
        if x == 1 or x == n - 1: continue
        for _ in range(r - 1):
            x = pow(x, 2, n)
            if x == n - 1: break
        else: return False
    return True

def find_next_prime(n):
    if n % 2 == 0: n += 1
    while not is_prime(n): n += 2
    return n

print(f"[*] Генерируем приватный ключ для {TARGET_USER}...")

# P = SHA256(seed)
h_p = hashlib.sha256(seed_bytes).digest()
p = find_next_prime(int.from_bytes(h_p, ENDIAN))

# Q = SHA256(seed + "pki") (SingleHash Mode)
h_q = hashlib.sha256(seed_bytes + b"pki").digest()
q = find_next_prime(int.from_bytes(h_q, ENDIAN))

# Вычисляем параметры RSA
n = p * q
phi = (p - 1) * (q - 1)
e = 65537
d = pow(e, -1, phi)

# Создаем объект ключа для библиотеки cryptography
private_key = rsa.RSAPrivateNumbers(
    p=p, q=q, d=d,
    dmp1=d % (p - 1),
    dmq1=d % (q - 1),
    iqmp=pow(q, -1, p),
    public_numbers=rsa.RSAPublicNumbers(e, n)
).private_key(default_backend())

print("[*] Ключ готов!")

# --- 2. ПОДПИСЬ (RSA-PSS) ---
# PSS использует случайную "соль", поэтому подпись каждый раз разная,
# но все они будут валидными.
signature = private_key.sign(
    MESSAGE.encode(),
    padding.PSS(
        mgf=padding.MGF1(hashes.SHA256()),
        salt_length=padding.PSS.MAX_LENGTH
    ),
    hashes.SHA256()
)

print(f"\n--- ВАЛИДНАЯ ПОДПИСЬ ДЛЯ ADMIN ---")
print(signature.hex())

-----BEGIN PRIVATE KEY-----
MIIBUQIBADANBgkqhkiG9w0BAQEFAASCATswggE3AgEAAkA4wvUChmqa9BWA/s99
q2z0OMxVEuDZ8esFuQGJgzfhFrdnmTTJ6APRg2v8xBlxLIghPFZIwEx/VXcqk2Xf
A9FDAgMBAAECQBzoniR1FSJqIfGa1U5p2onfy6Gghcg6f7pgaToCDJmkkPJrnTFg
yEX9TJnQDmoGtC94hXLXWhQWIOHhipl7vNECIEqMnfiP56WFh0qdmAmCBJX4gjww
LPd68EY+WeUi6divAiEAwureZmrzJf7BCc1GC6djuN1rkoAMnTGNkor8EJCcja0C
IEHQwUqHqagtKdNLLMYAHpJUko4WrixTQjuRooWz/CYLAiA39vnOTEzuDtxcNR00
gWZHkQOu96cnhy/P8Kn5E5xvrQIgHo+Vz5gwKn3Mq0SIY7vAZ3bSBuwcF3Mx4KwS
vsRnhZE=
-----END PRIVATE KEY-----

-----BEGIN PUBLIC KEY-----
MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAICyTyHQxpUuXHaI13bsS3hhMlAH7Oom
fthYPpBmb898d4FtfJCwx7XQWW9pL4Fw5DUFuD5EBcgMGiOIigdP3m8CAwEAAQ==
-----END PUBLIC KEY-----
