import paramiko
import sys
import termios
import tty
import select

# НАСТРОЙКИ
KEY_FILE = "id_rsa_admin"  # Убедись, что имя файла совпадает!
HOST = "10.80.135.211"
USER = "admin"

def interactive_shell(chan):
    oldtty = termios.tcgetattr(sys.stdin)
    try:
        tty.setraw(sys.stdin.fileno())
        tty.setcbreak(sys.stdin.fileno())
        chan.settimeout(0.0)
        while True:
            r, w, e = select.select([chan, sys.stdin], [], [])
            if chan in r:
                try:
                    x = chan.recv(1024)
                    if len(x) == 0: break
                    sys.stdout.write(x.decode())
                    sys.stdout.flush()
                except: break
            if sys.stdin in r:
                x = sys.stdin.read(1)
                if len(x) == 0: break
                chan.send(x)
    finally:
        termios.tcsetattr(sys.stdin, termios.TCSADRAIN, oldtty)

try:
    # Загружаем ключ
    key = paramiko.RSAKey.from_private_key_file(KEY_FILE)
    
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    
    print(f"[*] Connecting to {HOST} as {USER}...")
    print("[*] Forcing legacy ssh-rsa (SHA-1) signature...")

    # ВОТ ГЛАВНОЕ ИСПРАВЛЕНИЕ:
    # Мы запрещаем использовать SHA-2, чтобы Paramiko откатился на SHA-1
    client.connect(
        hostname=HOST, 
        username=USER, 
        pkey=key, 
        look_for_keys=False,
        allow_agent=False,
        disabled_algorithms={'pubkeys': ['rsa-sha2-256', 'rsa-sha2-512']} 
    )
    
    print("[+] Success! Shell opening...\n")
    
    channel = client.invoke_shell()
    interactive_shell(channel)
    
    channel.close()
    client.close()

except Exception as e:
    print(f"[-] Error: {e}")
